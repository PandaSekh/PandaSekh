<!doctype html><html lang=en><head><title>NextJS Free Commenting System using Github [Part 2/2] Â· Alessio Franceschi</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light"><meta name=author content="Alessio Franceschi"><meta name=description content="How to build a fully functional commenting system hosted on Github for free."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="NextJS Free Commenting System using Github [Part 2/2]"><meta name=twitter:description content="How to build a fully functional commenting system hosted on Github for free."><meta property="og:title" content="NextJS Free Commenting System using Github [Part 2/2]"><meta property="og:description" content="How to build a fully functional commenting system hosted on Github for free."><meta property="og:type" content="article"><meta property="og:url" content="https://alessiofranceschi.dev/blog/nextjs-free-commenting-system-part-2/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-10-09T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-09T00:00:00+00:00"><meta property="og:see_also" content="https://alessiofranceschi.dev/blog/nextjs-free-commenting-system-part-1/"><link rel=canonical href=https://alessiofranceschi.dev/blog/nextjs-free-commenting-system-part-2/><link rel=stylesheet href=/css/coder.min.c4d7e93a158eda5a65b3df343745d2092a0a1e2170feeec909b8a89443903c6a.css integrity="sha256-xNfpOhWO2lpls980N0XSCSoKHiFw/u7JCbiolEOQPGo=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/image/favicon.png sizes=32x32><link rel=icon type=image/png href=/image/favicon.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.102.3"></head><body class="preload-transitions colorscheme-light"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Alessio Franceschi</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/blog/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container page"><article><header><h1 class=title><a class=title-link href=https://alessiofranceschi.dev/blog/nextjs-free-commenting-system-part-2/>NextJS Free Commenting System using Github [Part 2/2]</a></h1></header><p><a href=https://alessiofranceschi.dev/blog/nextjs-free-commenting-system-part-1/ title="In the previous article">In the previous article</a> we built the basic interface for our commenting system. Now we need to program the API endpoints to communicate with Github&rsquo;s API in order to save and retrieve the comments.</p><div><h2>Table Of Contents</h2><nav id=TableOfContents><ul><li><a href=#save-comments>Save Comments</a><ul><li><a href=#prepare-the-data>Prepare the data</a></li><li><a href=#merge-parent-and-child-comments>Merge parent and child comments</a></li><li><a href=#update-the-data>Update the data</a></li><li><a href=#full-api-method>Full API method</a></li></ul></li><li><a href=#get-comments>Get Comments</a></li></ul></nav></div><h2 id=save-comments>Save Comments</h2><p>Let&rsquo;s start by saving some comment. In the <code>pages/api</code> path, let&rsquo;s create a new folder named <code>comments</code>, inside of which we&rsquo;ll create another folder named <code>save</code> and finally inside that a file named <code>[slug].ts</code>. Of course you can change the naming as you wish. You can also create a single path (for example, <code>/api/comment</code>) and then call different functions depending on the method used.
To save a comment, we need to:</p><ol><li>Check if the comment has a parent or not.</li><li>If it has a parent, then we need to append this comment to the parent</li><li>Else, we can insert this comment into the array of comments we might already have</li></ol><p>In both cases, we first need to request the data we already have, modify it and then update the repo.</p><h3 id=prepare-the-data>Prepare the data</h3><p>Let&rsquo;s start from a basic NextJS API function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>type</span> { <span style=color:#a6e22e>NextApiRequest</span>, <span style=color:#a6e22e>NextApiResponse</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;next&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> (<span style=color:#a6e22e>req</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>NextApiRequest</span>, <span style=color:#a6e22e>res</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>NextApiResponse</span>)<span style=color:#f92672>:</span> Promise<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>void</span><span style=color:#f92672>&gt;</span> =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>resolve</span>) =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Our code here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Inside this function, we&rsquo;ll first prepare the data sent to the API.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// Import the modules we need
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>encrypt</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@lib/encryption/crypto&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Comment</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@interfaces/Comment&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newComment</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Comment</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>date</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>date</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>parentCommentId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>parentCommentId</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>username</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>encrypt</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>email</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>string</span>),
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>content</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>children</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>children</span>,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>slug</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>query</span>;
</span></span></code></pre></div><h3 id=merge-parent-and-child-comments>Merge parent and child comments</h3><p>We need a function that will merge a child comment with its parent. Because we work with a basic Javascript object, we&rsquo;ll need
to use recursion to find the actual parent.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>appendToParent</span>(<span style=color:#a6e22e>comments</span><span style=color:#f92672>:</span> Array<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Comment</span><span style=color:#f92672>&gt;</span>, <span style=color:#a6e22e>newComment</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Comment</span>)<span style=color:#f92672>:</span> Array<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Comment</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comments</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>comment</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>newComment</span>.<span style=color:#a6e22e>parentCommentId</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>children</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>newComment</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>children</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>children</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>children</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>appendToParent</span>(<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>children</span>, <span style=color:#a6e22e>newComment</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>comments</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=update-the-data>Update the data</h3><p>Now we have the new comment data, so we need to get the previous data and modify it.
To communicate with Github&rsquo;s API I used the official library <code>@octokit/request</code>. From now on we&rsquo;ll work inside a <code>try</code> block.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>request</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@octokit/request&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Here we request the document in JSON (vnd.github.v3+json) because
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// with raw we don&#39;t have the file sha
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>prevComments</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>request</span>(
</span></span><span style=display:flex><span>		<span style=color:#75715e>// we request a GET on this path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#e6db74>&#34;GET /repos/{owner}/{repo}/contents/{path}&#34;</span>,
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// github private token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`token </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>GITHUB_TOKEN</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>				<span style=color:#75715e>// how we want the file. In this case, we want a JSON
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>accept</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;application/vnd.github.v3+json&#34;</span>,
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Owner of the repo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>owner</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;PandaSekh&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Name of the repo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>repo</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;my-blog-repo&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#75715e>// the path. I save the comments in a folder named comments in the root
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`comments/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>slug</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.json`</span>,
</span></span><span style=display:flex><span>			<span style=color:#75715e>// the branch
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>ref</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;prod&#34;</span>,
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	).<span style=color:#66d9ef>catch</span>((<span style=color:#a6e22e>e</span>) =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// We accept and will handle a 404 because not every post will have
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// comments. For any other error statusCode, throw an error.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>!==</span> <span style=color:#ae81ff>404</span>) <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#a6e22e>e</span>);
</span></span><span style=display:flex><span>	});
</span></span><span style=display:flex><span>	<span style=color:#75715e>// [...] We&#39;ll add more code here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Now that we have the new comment and, if present, the previous comments we can merge them and save the updated data. How we do this depends on the presence of previous comments.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// Still in the try block
</span></span></span><span style=display:flex><span><span style=color:#75715e>// if prevComments is undefined, there are no previous comments. This is the first possibility.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>prevComments</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// get the data from the base64 encoded content and parse it as JSON.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>prevComments</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>content</span>, <span style=color:#e6db74>&#34;base64&#34;</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#34;ascii&#34;</span>)
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Save the sha. We need it to update the file later on
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>sha</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>prevComments</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Merge the new comment to the parent if it has one. Else, simply add it to the array.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>newComment</span>.<span style=color:#a6e22e>parentCommentId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>appendToParent</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>newComment</span>); <span style=color:#75715e>// Merge the parent and the child comment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>newComment</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Save the updated comments to Github
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>update</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>request</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;PUT /repos/{owner}/{repo}/contents/{path}&#34;</span>,
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// github private token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`token </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>GITHUB_TOKEN</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#75715e>// how we want the file. In this case, we want a JSON
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>accept</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;application/vnd.github.v3+json&#34;</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Owner of the repo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>owner</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;PandaSekh&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Name of the repo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>repo</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;my-blog-repo&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#75715e>// the path. I save the comments in a folder named comments in the root
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`comments/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>slug</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.json`</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>branch</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;prod&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Updated comment on post </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>slug</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#75715e>// Git commit message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>sha</span>, <span style=color:#75715e>// The sha we saved before
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>data</span>), <span style=color:#e6db74>&#34;ascii&#34;</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#34;base64&#34;</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>update</span>));
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resolve</span>();
</span></span></code></pre></div><p>And now we write the else in case there were no comments before the new one.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> [<span style=color:#a6e22e>newComment</span>];
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Save the new comment to Github
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>update</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>request</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;PUT /repos/{owner}/{repo}/contents/{path}&#34;</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#75715e>// github private token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#a6e22e>authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`token </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>GITHUB_TOKEN</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>          <span style=color:#75715e>// how we want the file. In this case, we want a JSON
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#a6e22e>accept</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;application/vnd.github.v3+json&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Owner of the repo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>owner</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;PandaSekh&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Name of the repo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>repo</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;my-blog-repo&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#75715e>// the path. I save the comments in a folder named comments in the root
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`comments/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>slug</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.json`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>branch</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;prod&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`New comment on post </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>slug</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#75715e>// Git commit message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>data</span>), <span style=color:#e6db74>&#34;ascii&#34;</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#34;base64&#34;</span>),
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>update</span>));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resolve</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>e</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resolve</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=full-api-method>Full API method</h3><p>Below the complete API method for reference.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>request</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@octokit/request&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>type</span> { <span style=color:#a6e22e>NextApiRequest</span>, <span style=color:#a6e22e>NextApiResponse</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;next&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Comment</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@interfaces/Comment&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>encrypt</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@lib/encryption/crypto&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>appendToParent</span>( <span style=color:#a6e22e>comments</span><span style=color:#f92672>:</span> Array<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Comment</span><span style=color:#f92672>&gt;</span>, <span style=color:#a6e22e>newComment</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Comment</span> )<span style=color:#f92672>:</span> Array<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Comment</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comments</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>comment</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>newComment</span>.<span style=color:#a6e22e>parentCommentId</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>children</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>newComment</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>children</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>children</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>children</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>appendToParent</span>(<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>children</span>, <span style=color:#a6e22e>newComment</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>comments</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> (<span style=color:#a6e22e>req</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>NextApiRequest</span>, <span style=color:#a6e22e>res</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>NextApiResponse</span>)<span style=color:#f92672>:</span> Promise<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>void</span><span style=color:#f92672>&gt;</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>resolve</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newComment</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Comment</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>date</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>date</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>parentCommentId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>parentCommentId</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>username</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>encrypt</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>email</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>string</span>),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>content</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>children</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>children</span>,
</span></span><span style=display:flex><span>		};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>slug</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>query</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>prevComments</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>request</span>(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;GET /repos/{owner}/{repo}/contents/{path}&#34;</span>,
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`token </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>GITHUB_TOKEN</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>accept</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;application/vnd.github.v3+json&#34;</span>,
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>owner</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;PandaSekh&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>repo</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;my-blog-repo&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`comments/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>slug</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.json`</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>ref</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;prod&#34;</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ).<span style=color:#66d9ef>catch</span>((<span style=color:#a6e22e>e</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>!==</span> <span style=color:#ae81ff>404</span>) <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#a6e22e>e</span>);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>prevComments</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>prevComments</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>content</span>, <span style=color:#e6db74>&#34;base64&#34;</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#34;ascii&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>sha</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>prevComments</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>newComment</span>.<span style=color:#a6e22e>parentCommentId</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>appendToParent</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>newComment</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>newComment</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>update</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>request</span>(
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;PUT /repos/{owner}/{repo}/contents/{path}&#34;</span>,
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`token </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>GITHUB_TOKEN</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>accept</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;application/vnd.github.v3+json&#34;</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>owner</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;PandaSekh&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>repo</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;my-blog-repo&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`comments/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>slug</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.json`</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>branch</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;prod&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Updated comment on post </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>slug</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sha</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>data</span>), <span style=color:#e6db74>&#34;ascii&#34;</span>).<span style=color:#a6e22e>toString</span>(
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;base64&#34;</span>
</span></span><span style=display:flex><span>            ),
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>update</span>));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resolve</span>();
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> [<span style=color:#a6e22e>newComment</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>update</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>request</span>(
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;PUT /repos/{owner}/{repo}/contents/{path}&#34;</span>,
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`token </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>GITHUB_TOKEN</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>accept</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;application/vnd.github.v3+json&#34;</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>owner</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;PandaSekh&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>repo</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;my-blog-repo&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`comments/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>slug</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.json`</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>branch</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;prod&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`New comment on post </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>slug</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>data</span>), <span style=color:#e6db74>&#34;ascii&#34;</span>).<span style=color:#a6e22e>toString</span>(
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;base64&#34;</span>
</span></span><span style=display:flex><span>            ),
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>       
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>update</span>));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resolve</span>();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>e</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>resolve</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=get-comments>Get Comments</h2><p>The method to retrieve comments depends on how you want to build your website. As I expected very few comments and I wanted the website to be fully static, I get the comments in a <code>GetStaticProps</code> method inside the <code>[slug].tsx</code> page. Every new comment triggers a re-deploy and rebuild the site. This is not the best approach if you expect a moderate amount of comments, in that case it might be a better idea to use <code>GetServerSideProps</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// This method will vary depending on your needs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getStaticProps</span>({ <span style=color:#a6e22e>params</span> }<span style=color:#f92672>:</span> { <span style=color:#a6e22e>params</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>slug</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span> }})<span style=color:#f92672>:</span> Promise<span style=color:#f92672>&lt;</span>{ <span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Props</span> }<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>comments</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>getComments</span>(<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>slug</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span> 			<span style=color:#a6e22e>comments</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getComments</span>( <span style=color:#a6e22e>slug</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span> )<span style=color:#f92672>:</span> Promise<span style=color:#f92672>&lt;</span>Array<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Comment</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>comments</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>request</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;GET /repos/{owner}/{repo}/contents/{path}&#34;</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`token </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>GITHUB_TOKEN</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>accept</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;application/vnd.github.v3.raw&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>owner</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;PandaSekh&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>repo</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;your-blog-repo&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`../../comments/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>slug</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.json`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ref</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;prod&#34;</span>,
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>comments</span>.<span style=color:#a6e22e>data</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>unknown</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>string</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That&rsquo;s all! This is how I built my free static commenting system.
If you have any doubts you can comment here or write me on my social media.</p><p>Full Series:</p><ul><li>1/3 <a href=https://alessiofranceschi.dev/blog/nextjs-free-commenting-system-part-1/ title="NextJS Free Commenting System using Github Part 1">NextJS Free Commenting System using Github Part 1</a></li><li>1/3 <a href=https://alessiofranceschi.dev/blog/nextjs-free-commenting-system-part-2/ title="NextJS Free Commenting System using Github Part 2">NextJS Free Commenting System using Github Part 2</a></li></ul></article></section></div><footer class=footer><section class=container>Â©
2022
Alessio Franceschi
Â·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/PandaSekh/hugo-coder-lt>Coder-Lt</a>.</section></footer></main></body></html>