<!doctype html><html lang=en><head><title>Building a Real-Time Commenting System in React [Part 1/3] · Alessio Franceschi</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light"><meta name=author content="Alessio Franceschi"><meta name=description content="A series on how to build a fully features Commenting System in Next.js (React)"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building a Real-Time Commenting System in React [Part 1/3]"><meta name=twitter:description content="A series on how to build a fully features Commenting System in Next.js (React)"><meta property="og:title" content="Building a Real-Time Commenting System in React [Part 1/3]"><meta property="og:description" content="A series on how to build a fully features Commenting System in Next.js (React)"><meta property="og:type" content="article"><meta property="og:url" content="https://alessiofranceschi.dev/blog/react-commenting-system/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-01-12T00:00:00+00:00"><meta property="article:modified_time" content="2021-01-12T00:00:00+00:00"><meta property="og:see_also" content="https://alessiofranceschi.dev/blog/react-commenting-system-part-3/"><meta property="og:see_also" content="https://alessiofranceschi.dev/blog/react-commenting-system-part-2/"><link rel=canonical href=https://alessiofranceschi.dev/blog/react-commenting-system/><link rel=stylesheet href=/css/coder.min.c4d7e93a158eda5a65b3df343745d2092a0a1e2170feeec909b8a89443903c6a.css integrity="sha256-xNfpOhWO2lpls980N0XSCSoKHiFw/u7JCbiolEOQPGo=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/image/favicon.png sizes=32x32><link rel=icon type=image/png href=/image/favicon.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.102.3"></head><body class="preload-transitions colorscheme-light"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Alessio Franceschi</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/blog/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container page"><article><header><h1 class=title><a class=title-link href=https://alessiofranceschi.dev/blog/react-commenting-system/>Building a Real-Time Commenting System in React [Part 1/3]</a></h1></header><p>One of my latest projects is an entire blog built with Next.js, a framework based on React. One of the features I wanted was a commenting system, but none of those already available were interesting for me and I wanted full control on the features and the data. Because of that, I decided to create my own commenting system. This article is meant to show the process of creating it and there’s a <a href=https://github.com/PandaSekh/React-Commenting-System>repo on GitHub</a> with the full code for reference.</p><div><h2>Table Of Contents</h2><nav id=TableOfContents><ul><li><a href=#features>Features</a><ul><li><a href=#why-nextjs>Why Next.js</a></li><li><a href=#why-sanityio>Why Sanity.io</a></li></ul></li><li><a href=#project-setup>Project Setup</a><ul><li><a href=#data-schemas>Data Schemas</a></li></ul></li><li><a href=#create-comments>Create Comments</a><ul><li><a href=#front-end-component>Front-end Component</a></li><li><a href=#serverless-backend>Serverless Backend</a></li></ul></li><li><a href=#displaying-the-comments>Displaying the Comments</a></li></ul></nav></div><h2 id=features>Features</h2><p>First of all, let’s talk about what features I wanted to implement:</p><ul><li>Easy for the end user to comment, anonymous-first</li><li>Nested comments</li><li>Reactions (or upvote system like Reddit, but I prefer emoticons over that)</li><li>Real-Time: new comments and reaction shown without reloading the page</li><li>Markdown support (for nicely formatted comments</li><li>ReCaptcha v3 (I don’t want to manually approve comments)</li></ul><p>For this project I used Next.js and Sanity.io, but they’re not a must for this commenting system. I used both because that’s what I’m using for my blog project, but here’s a brief explanation on why I’m using them and what else can you use.</p><h3 id=why-nextjs>Why Next.js</h3><p>Next.js is “an open-source React front-end development web framework that enables functionality such as server-side rendering and generating static websites for React based web applications.”. While this is great, we don’t need server-side rendering for the commenting system, but Next.js also automatically supports serverless functions. Anything under the “pages/api” folder is a serverless function and we’re going to use them to handle the creation of new comments. If you don’t want to use Next.js, you can simply move the serverless functions elsewhere, for example on AWS Lambda.</p><h3 id=why-sanityio>Why Sanity.io</h3><p>Sanity is a CMS with quite a lot of interesting features. In this project I’m going to use it mostly as a NoSQL database, but the Javascript client includes the possibility to create an RxJS subscription to a query which will come handy when making the commenting system real-time. If you want to use a different NoSQL database and keep the real time features, you need to create an RxJS subscription yourself.</p><p>After all this introductions, we can start our project.</p><h2 id=project-setup>Project Setup</h2><p>With <code>npx create-next-app</code> we create the basic project structure. If you don’t know how Next.JS works, the <a href=https://nextjs.org/docs>Getting Started</a> guide is amazing, but here’s a short introduction. Everything under the <code>pages</code> folder will be an actual page with the slug being the filename, while the files under <code>pages/api</code> will be serverless functions listening at <code>website.com/api/[name_of_file]</code>. To test your app, run the command <code>npm run dev</code> That’s all we need to know for this project.</p><p>In the project folder, run the command <code>npm i -save @sanity/client</code> to install the Javascript Sanity Client, which will help us make queries to the dataset. Follow the on-screen prompts to create a new dataset. In the client folder, under the <code>schemas</code> folder we’ll create our two schemas, one for the comments and one for the reactions.</p><h3 id=data-schemas>Data Schemas</h3><p>The Comment Schema will include a name, an email, an image (more on that later), the comment itself and a boolean for it’s approved state. I previously said that all comments are approved by default, but I think that comments with urls should not, so I added this flag.
For more information about the schemas for Sanity.io, check out <a href=https://www.sanity.io/docs/content-modelling>their documentation</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;comment&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Comment&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;document&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fields</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;name&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;User Name&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;email&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Email&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;userImage&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;User Image&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;image&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>options</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>hotspot</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;comment&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Comment&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;childComments&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Child Comments&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;array&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>of</span><span style=color:#f92672>:</span> [{ <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;comment&#34;</span> }],
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;approved&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Approved&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;boolean&#34;</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	],
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>preview</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>select</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;name&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>subtitle</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;comment&#34;</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>For the reactions, the schema must include a comment id (I went for a string instead of a reference because in this use case, where object are linked programmatically, I felt it was a better choice), and an array of reaction objects, which include the emoji itself, a counter and a label.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;commentReactions&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Comment Reactions&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;document&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fields</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;commentId&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Comment Id&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;reactions&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Reactions&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;array&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>of</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>fields</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>						{
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;emoji&#34;</span>,
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span>,
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Emoji&#34;</span>,
</span></span><span style=display:flex><span>						},
</span></span><span style=display:flex><span>						{
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;counter&#34;</span>,
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;number&#34;</span>,
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Counter&#34;</span>,
</span></span><span style=display:flex><span>						},
</span></span><span style=display:flex><span>						{
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;label&#34;</span>,
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span>,
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Label&#34;</span>,
</span></span><span style=display:flex><span>						},
</span></span><span style=display:flex><span>					],
</span></span><span style=display:flex><span>				},
</span></span><span style=display:flex><span>			],
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	],
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>preview</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>select</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;commentId&#34;</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=create-comments>Create Comments</h2><h3 id=front-end-component>Front-end Component</h3><p>In the root folder create a new folder, <code>components</code>, and inside that create another folder called <code>AddCommentForm</code> to keep things tidy. Create a new component called <code>AddCommentForm.js</code> and create a Form for new comments. The component itself isn’t anything special and you can do it however you want, I used React Hook Form and you can see it <a href=https://github.com/PandaSekh/React-Commenting-System/blob/main/components/AddComment/AddCommentForm.js>here</a>. The important part is the submission handler, but for now we’ll keep things simple and we’ll come back later to make some adjustments when we add nested comments. Now we’ll just make a fetch in POST to our soon-to-be-made API, like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#34;/api/addComment&#34;</span>, {<span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;POST&#34;</span>, <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>data</span>)})
</span></span></code></pre></div><p>Where data is the data from the form (with React Hook Form, it’s the parameter automatically passed to the handleSubmit callback).</p><p>The full code should look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>useForm</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react-hook-form&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Fragment</span>, <span style=color:#a6e22e>useState</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>AddCommentForm</span>(){
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>isSending</span>, <span style=color:#a6e22e>setIsSending</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>register</span>, <span style=color:#a6e22e>errors</span>, <span style=color:#a6e22e>handleSubmit</span>, <span style=color:#a6e22e>reset</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>useForm</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>onSubmit</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>data</span> =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>setIsSending</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#34;/api/addComment&#34;</span>, {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;POST&#34;</span>, 
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>r</span> =&gt; {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>200</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>setIsSending</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> <span style=color:#75715e>// handle errors;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>			&lt;<span style=color:#f92672>form</span> <span style=color:#a6e22e>onSubmit</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>handleSubmit</span>(<span style=color:#a6e22e>onSubmit</span>)}&gt;
</span></span><span style=display:flex><span>				&lt;<span style=color:#f92672>input</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text&#34;</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>placeholder</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Name (Optional)&#34;</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;name&#34;</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>ref</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>register</span>({ <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>maxLength</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>80</span> })}
</span></span><span style=display:flex><span>				/&gt;
</span></span><span style=display:flex><span>				&lt;<span style=color:#f92672>input</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text&#34;</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>placeholder</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Email (Optional)&#34;</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;email&#34;</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>ref</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>register</span>({ <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>pattern</span><span style=color:#f92672>:</span> <span style=color:#e6db74>/^\S+@\S+$/i</span> })}
</span></span><span style=display:flex><span>				/&gt;
</span></span><span style=display:flex><span>				{<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>email</span> <span style=color:#f92672>&amp;&amp;</span> &lt;<span style=color:#f92672>span</span>&gt;<span style=color:#a6e22e>Invalid</span> <span style=color:#a6e22e>email</span>&lt;/<span style=color:#f92672>span</span>&gt;}
</span></span><span style=display:flex><span>				&lt;<span style=color:#f92672>textarea</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;comment&#34;</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>placeholder</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Your Comment&#34;</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>rows</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;5&#34;</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>ref</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>register</span>({ <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>maxLength</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5000</span> })}
</span></span><span style=display:flex><span>				/&gt;
</span></span><span style=display:flex><span>				{<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>comment</span> <span style=color:#f92672>&amp;&amp;</span> (
</span></span><span style=display:flex><span>					&lt;<span style=color:#f92672>span</span>&gt;<span style=color:#a6e22e>You</span> <span style=color:#a6e22e>need</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>write</span> <span style=color:#a6e22e>something</span>&lt;/<span style=color:#f92672>span</span>&gt;
</span></span><span style=display:flex><span>				)}
</span></span><span style=display:flex><span>				&lt;<span style=color:#f92672>input</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;submit&#34;</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>disabled</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>isSending</span>}
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>isSending</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;Sending Comment...&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Send Comment&#34;</span>}
</span></span><span style=display:flex><span>				/&gt;
</span></span><span style=display:flex><span>			&lt;/<span style=color:#f92672>form</span>&gt;
</span></span><span style=display:flex><span>	);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Import and add this Component in your <code>pages/index.js</code> file to use it.</p><h3 id=serverless-backend>Serverless Backend</h3><p>First of call, create a Sanity Client. As we&rsquo;ll need this client in different places, let&rsquo;s create a file just for him.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// lib/sanityClient.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sanityClient</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;@sanity/client&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>writeClient</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sanityClient</span>({
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>projectId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>NEXT_PUBLIC_SANITY_PROJECT_ID</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dataset</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>NEXT_PUBLIC_SANITY_DATASET</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>SANITY_W_TOKEN</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>useCdn</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>You can get all those infos in your Sanity Dashboard. For the token see <a href=https://www.sanity.io/docs/keeping-your-data-safe#take-good-care-of-your-access-tokens-a99296355dc1>here</a>.</p><p>Now, in <code>pages/api</code>, create a new file and call it <code>addComment.js</code>. Here we’ll create and add the new comment to Sanity.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// We need this to generate random keys both here and later when we’ll map React Components
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>nanoid</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;nanoid&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Sanitize the html for security reasons
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>sanitizeHtml</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;sanitize-html&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// RegEx to identify urls and set the comment as unapproved 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>urlRegEx</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#e6db74>&#34;([a-zA-Z0-9]+://)?([a-zA-Z0-9_]+:[a-zA-Z0-9_]+@)?([a-zA-Z0-9.-]+\\.[A-Za-z]{2,4})(:[0-9]+)?([^ ])+&#34;</span>);
</span></span></code></pre></div><p>Create a handler for the serverless function, which will be the default export.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {}
</span></span></code></pre></div><p>This will return a new Promise (otherwise it will give warnings in dev and will not work in production)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Inside, we’ll create a new object with the values required by the dataset and those we got from the request.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>const</span> document <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>);
</span></span><span style=display:flex><span>		document .<span style=color:#a6e22e>_type</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;comment&#34;</span>;
</span></span><span style=display:flex><span>		document .<span style=color:#a6e22e>_key</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>nanoid</span>();
</span></span><span style=display:flex><span>		document .<span style=color:#a6e22e>_id</span> <span style=color:#f92672>=</span> document .<span style=color:#a6e22e>_key</span>;
</span></span><span style=display:flex><span>		document .<span style=color:#a6e22e>_createdAt</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>		document .<span style=color:#a6e22e>comment</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sanitizeHtml</span>(document .<span style=color:#a6e22e>comment</span>, {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>allowedTags</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;b&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;em&#34;</span>, <span style=color:#e6db74>&#34;strong&#34;</span>, <span style=color:#e6db74>&#34;a&#34;</span>, <span style=color:#e6db74>&#34;li&#34;</span>, <span style=color:#e6db74>&#34;ul&#34;</span>],
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>allowedAttributes</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>a</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;href&#34;</span>],
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>		});
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>name</span>) <span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Anonymous&#34;</span>;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>match</span>(<span style=color:#a6e22e>urlRegEx</span>)) <span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>approved</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>approved</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>writeClient</span>.<span style=color:#a6e22e>create</span>(document).<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>resolve</span>(
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Comment Created&#34;</span> })
</span></span><span style=display:flex><span>					);
</span></span><span style=display:flex><span>				});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> String(<span style=color:#a6e22e>err</span>) }));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The new comment section is now complete! We can successfully create and save new comments.</p><h2 id=displaying-the-comments>Displaying the Comments</h2><p>To show comments, create a new folder in the <code>components</code> folder and call it <code>Comments</code>. Inside, we&rsquo;ll first create the component to show a single comment, so create a new file and call it <code>SingleComment.js</code>.
This component will take a comment object from its parent and render it, simple as that.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>useState</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Comment</span>({ <span style=color:#a6e22e>comment</span> }) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>		&lt;<span style=color:#f92672>li</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>key</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>_id</span>}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>id</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>_id</span>}
</span></span><span style=display:flex><span>		&gt;
</span></span><span style=display:flex><span>			&lt;<span style=color:#f92672>span</span>&gt;
</span></span><span style=display:flex><span>				&lt;<span style=color:#f92672>span</span>&gt;
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>Comment</span> <span style=color:#a6e22e>by</span> &lt;<span style=color:#f92672>strong</span>&gt;{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>name</span>}&lt;/<span style=color:#f92672>strong</span>&gt; <span style=color:#a6e22e>on</span>{<span style=color:#e6db74>&#34; &#34;</span>}
</span></span><span style=display:flex><span>					&lt;<span style=color:#f92672>strong</span>&gt;{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>_createdAt</span>}&lt;/<span style=color:#f92672>strong</span>&gt;
</span></span><span style=display:flex><span>				&lt;/<span style=color:#f92672>span</span>&gt;
</span></span><span style=display:flex><span>			&lt;/<span style=color:#f92672>span</span>&gt;
</span></span><span style=display:flex><span>			&lt;<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>			{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>trim</span>()}
</span></span><span style=display:flex><span>			&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>		&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>	);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In the <code>Comments</code> folder, create a new component and call it <code>AllComments.js</code>. This will render all of our comments.
First of all, we&rsquo;ll set in the state all comments using the <code>useEffect</code> hook, like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>useState</span>, <span style=color:#a6e22e>useEffect</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Comment</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./SingleComment&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>query</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`*[_type == &#34;comment&#34; &amp;&amp; approved==true]{_id, comment, name, _createdAt, childComments} | order (_createdAt)`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>AllComments</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>comments</span>, <span style=color:#a6e22e>setComments</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>useEffect</span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>setComments</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>query</span>));
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The query asks for every approved comment ordered by creation date. We can already make the comments real-time thanks to Sanity integration of RxJS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>useState</span>, <span style=color:#a6e22e>useEffect</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Comment</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./SingleComment&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>writeClient</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../lib/sanityClient&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>query</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`*[_type == &#34;comment&#34; &amp;&amp; approved==true]{_id, comment, name, _createdAt, childComments} | order (_createdAt)`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create a new globally scoped variable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>querySub</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>undefined</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>AllComments</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>comments</span>, <span style=color:#a6e22e>setComments</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>useEffect</span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>setComments</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>writeClient</span>.<span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>query</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Subscribe to the query, listening to new updates
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// If there&#39;s an update, add it to the comments state and sort it again
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// The update might occur on a comment we already have in the state,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// so we should filter out that comment from the previous state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>querySub</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>writeClient</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>query</span>).<span style=color:#a6e22e>subscribe</span>(<span style=color:#a6e22e>update</span> =&gt; {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>update</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>setComments</span>(<span style=color:#a6e22e>comments</span> =&gt;
</span></span><span style=display:flex><span>					[
</span></span><span style=display:flex><span>						...<span style=color:#a6e22e>comments</span>.<span style=color:#a6e22e>filter</span>(
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>comment</span> =&gt; <span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>_id</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>_id</span>
</span></span><span style=display:flex><span>						),
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>update</span>.<span style=color:#a6e22e>result</span>,
</span></span><span style=display:flex><span>					].<span style=color:#a6e22e>sort</span>((<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span>) =&gt; (<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>_createdAt</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>_createdAt</span> <span style=color:#f92672>?</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>				);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Unsubscribe on Component unmount
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> () =&gt; {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>querySub</span>.<span style=color:#a6e22e>unsubscribe</span>();
</span></span><span style=display:flex><span>		};
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now that we have all the comments in our state, we can easily render them</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>commentList</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>comments</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>comment</span> =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>Comment</span> <span style=color:#a6e22e>key</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>_id</span>} <span style=color:#a6e22e>comment</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>comment</span>} /&gt;;
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>	&lt;<span style=color:#f92672>ul</span>&gt;{<span style=color:#a6e22e>commentList</span>}&lt;/<span style=color:#f92672>ul</span>&gt;
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>That&rsquo;s it! Add the <code>AllComments</code> component in the <code>index.js</code> file and now you can add and see comments with real-time updates!</p><p><a href=https://alessiofranceschi.dev/blog/react-commenting-system-part-2/ title="In the second part">In the second part</a>, we&rsquo;ll add the nested comments funcionality and some other small features, like Markdown spport.</p><p>Full Series:</p><ul><li>1/3 <a href=https://alessiofranceschi.dev/blog/react-commenting-system/ title="Building a Real-Time Commenting System in React">Building a Real-Time Commenting System in React</a></li><li>2/3 <a href=https://alessiofranceschi.dev/blog/react-commenting-system-part-2/ title="Making Nested Comments">Making Nested Comments</a></li><li>3/3 <a href=https://alessiofranceschi.dev/blog/react-commenting-system-part-3/ title="Emoji Reactions for Comments">Emoji Reactions for Comments</a></li></ul></article></section></div><footer class=footer><section class=container>©
2022
Alessio Franceschi
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/PandaSekh/hugo-coder-lt>Coder-Lt</a>.</section></footer></main></body></html>