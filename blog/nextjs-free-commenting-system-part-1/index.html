<!doctype html><html lang=en><head><title>NextJS Free Commenting System using Github [Part 1/2] Â· Alessio Franceschi</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light"><meta name=author content="Alessio Franceschi"><meta name=description content="How to build a fully functional commenting system hosted on Github for free."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="NextJS Free Commenting System using Github [Part 1/2]"><meta name=twitter:description content="How to build a fully functional commenting system hosted on Github for free."><meta property="og:title" content="NextJS Free Commenting System using Github [Part 1/2]"><meta property="og:description" content="How to build a fully functional commenting system hosted on Github for free."><meta property="og:type" content="article"><meta property="og:url" content="https://alessiofranceschi.dev/blog/nextjs-free-commenting-system-part-1/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-10-08T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-08T00:00:00+00:00"><meta property="og:see_also" content="https://alessiofranceschi.dev/blog/nextjs-free-commenting-system-part-2/"><link rel=canonical href=https://alessiofranceschi.dev/blog/nextjs-free-commenting-system-part-1/><link rel=stylesheet href=/css/coder.min.c4d7e93a158eda5a65b3df343745d2092a0a1e2170feeec909b8a89443903c6a.css integrity="sha256-xNfpOhWO2lpls980N0XSCSoKHiFw/u7JCbiolEOQPGo=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/image/favicon.png sizes=32x32><link rel=icon type=image/png href=/image/favicon.png sizes=16x16><link rel=apple-touch-icon href=/image/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/image/apple-touch-icon.png><link rel=mask-icon href=/image/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.102.3"></head><body class="preload-transitions colorscheme-light"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Alessio Franceschi</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/blog/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container page"><article><header><h1 class=title><a class=title-link href=https://alessiofranceschi.dev/blog/nextjs-free-commenting-system-part-1/>NextJS Free Commenting System using Github [Part 1/2]</a></h1></header><p>In a recent project of mine built with NextJS and hosted on Vercel I wanted to implement a simple but functional commenting system. While I <a href=https://alessiofranceschi.dev/blog/react-commenting-system/ title="already did a commenting system">already did a commenting system</a>, it was using an external CMS (Sanity.io). Sanity is great, but for this project I had two different goals:</p><ul><li>I wanted it to be totally free, without limits</li><li>I wanted total control over the data</li></ul><p>The solution I came up with was using Github as a database for the comments. Github&rsquo;s API allows us to make commits (save comments) and retrieve files from a repository (get the comments). Please note that this is a great solution for a cheap and low-traffic website, otherwise it&rsquo;s just better to use a database. Anyway, this was a fun little challenge.</p><p>The features of this commenting system are:</p><ul><li>It&rsquo;s totally free</li><li>Infinite child comments</li><li>Can have any parameters you want (Profile pictures, date of comment, etc)</li><li>Privacy is maintained even if the repo is public</li><li>Data is yours and easily manageable (it&rsquo;s just a JSON)</li></ul><p>It this series of articles I&rsquo;ll illustrate how I managed to use Github as my comments database for a NextJS - and typescript - commenting system.</p><div><h2>Table Of Contents</h2><nav id=TableOfContents><ul><li><a href=#basic-utils>Basic Utils</a><ul><li><a href=#email-encryption>Email Encryption</a></li><li><a href=#interfaces>Interfaces</a></li></ul></li><li><a href=#design-the-comments-section>Design the Comments Section</a><ul><li><a href=#single-comment-component>Single Comment Component</a></li><li><a href=#add-comment-form>Add Comment Form</a></li><li><a href=#full-comment-block>Full Comment Block</a></li></ul></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></div><h2 id=basic-utils>Basic Utils</h2><p>First of all, we need to create some basic utils that we&rsquo;ll use later on.</p><h3 id=email-encryption>Email Encryption</h3><p>In this series of articles I&rsquo;ll build a commenting systems that requires an email, and as such I&rsquo;ll encrypt just that. You can skip this step if you don&rsquo;t need to encrypt sensitive data.
To protect the users&rsquo; privacy, I&rsquo;ll use the <code>crypto</code> library of Node.js with the AES-256 algorithm.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>crypto</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;crypto&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>algorithm</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;aes-256-ctr&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>iv</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>randomBytes</span>(<span style=color:#ae81ff>16</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>encrypt</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Hash</span> =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secretKey</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CRYPTO_SECRET_KEY</span>; <span style=color:#75715e>// Random secret key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>secretKey</span>) <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;No secret&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cipher</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>createCipheriv</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>algorithm</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>crypto</span>
</span></span><span style=display:flex><span>			.<span style=color:#a6e22e>createHash</span>(<span style=color:#e6db74>&#34;sha256&#34;</span>)
</span></span><span style=display:flex><span>			.<span style=color:#a6e22e>update</span>(String(<span style=color:#a6e22e>secretKey</span>))
</span></span><span style=display:flex><span>			.<span style=color:#a6e22e>digest</span>(<span style=color:#e6db74>&#34;base64&#34;</span>)
</span></span><span style=display:flex><span>			.<span style=color:#a6e22e>substr</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>32</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>iv</span>
</span></span><span style=display:flex><span>	);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>encrypted</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>concat</span>([<span style=color:#a6e22e>cipher</span>.<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>text</span>), <span style=color:#a6e22e>cipher</span>.<span style=color:#66d9ef>final</span>()]);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>iv</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>iv</span>.<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#34;hex&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>encrypted</span>.<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#34;hex&#34;</span>),
</span></span><span style=display:flex><span>	};
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>decrypt</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>hash</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Hash</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span> =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secretKey</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CRYPTO_SECRET_KEY</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>secretKey</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>decipher</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>createDecipheriv</span>(
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>algorithm</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>crypto</span>
</span></span><span style=display:flex><span>				.<span style=color:#a6e22e>createHash</span>(<span style=color:#e6db74>&#34;sha256&#34;</span>)
</span></span><span style=display:flex><span>				.<span style=color:#a6e22e>update</span>(String(<span style=color:#a6e22e>secretKey</span>))
</span></span><span style=display:flex><span>				.<span style=color:#a6e22e>digest</span>(<span style=color:#e6db74>&#34;base64&#34;</span>)
</span></span><span style=display:flex><span>				.<span style=color:#a6e22e>substr</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>32</span>),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>hash</span>.<span style=color:#a6e22e>iv</span>, <span style=color:#e6db74>&#34;hex&#34;</span>)
</span></span><span style=display:flex><span>		);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>decrpyted</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>concat</span>([
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>decipher</span>.<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>hash</span>.<span style=color:#a6e22e>content</span>, <span style=color:#e6db74>&#34;hex&#34;</span>)),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>decipher</span>.<span style=color:#66d9ef>final</span>(),
</span></span><span style=display:flex><span>	]);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>decrpyted</span>.<span style=color:#a6e22e>toString</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>throw</span> Error(<span style=color:#e6db74>&#34;No secret key&#34;</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> { <span style=color:#a6e22e>encrypt</span>, <span style=color:#a6e22e>decrypt</span> };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Hash</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>iv</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The details of the crypto library can be found <a href=https://nodejs.org/api/crypto.html#crypto_crypto_createcipheriv_algorithm_key_iv_options>in the official docs</a>.
The important thing to understand is that we pass to the <code>encrypt</code> method a string (the email) and it returns an <code>Hash</code> object, which we&rsquo;ll save in the comment JSON instead of the email itself.
When we need the user&rsquo;s email, we call the <code>decrypt</code> method.</p><h3 id=interfaces>Interfaces</h3><p>As we&rsquo;re working with Typescript We first need to create the interfaces of the objects we&rsquo;ll be using.</p><p><strong>Comment Interface</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// IComment.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Hash</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@lib/encryption/crypto&#34;</span>; <span style=color:#75715e>// That&#39;s the Hash interface we created before
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Comment</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Mandatory parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>; <span style=color:#75715e>// Unique id of the comment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>; <span style=color:#75715e>// The comment itself
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>children</span><span style=color:#f92672>:</span> Array<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Comment</span><span style=color:#f92672>&gt;</span>; <span style=color:#75715e>// Children of this comment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>parentCommentId</span><span style=color:#f92672>?:</span> <span style=color:#a6e22e>string</span>; <span style=color:#75715e>// Optional parent comment id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// These are optionals, based on one&#39;s needs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>date</span><span style=color:#f92672>:</span> Date;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Hash</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=design-the-comments-section>Design the Comments Section</h2><p>Starting from the basics, we need a simple comments section. I won&rsquo;t cover css as it&rsquo;s out of the scope of this articles.</p><h3 id=single-comment-component>Single Comment Component</h3><p>In our <code>components</code> folder, let&rsquo;s create a folder <code>Comments</code> and a component called <code>Comment.tsx</code>. This component will render a single comment and its children.
This structure is based on what I needed, but can be changed accordingly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>dynamic</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;next/dynamic&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>useEffect</span>, <span style=color:#a6e22e>useRef</span>, <span style=color:#a6e22e>useState</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>IComment</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@interfaces/Comment&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>decrypt</span>, <span style=color:#a6e22e>Hash</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@lib/encryption/crypto&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Comment</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comment</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>slug</span>,
</span></span><span style=display:flex><span>}<span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comment</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>IComment</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>slug</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>;
</span></span><span style=display:flex><span>})<span style=color:#f92672>:</span> <span style=color:#a6e22e>JSX</span>.<span style=color:#a6e22e>Element</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>reply</span>, <span style=color:#a6e22e>setReply</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#66d9ef>false</span>); <span style=color:#75715e>// This state will manage the reply form
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>AddComment</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dynamic</span>(() =&gt; <span style=color:#66d9ef>import</span>(<span style=color:#e6db74>&#34;./AddComment&#34;</span>)); <span style=color:#75715e>// No need to import this component if the user won&#39;t click on &#34;Reply&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>div</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// If this is a child component, we apply a custom class. This is useful to offset child comments from the parent and make a hierachy effect
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span>{<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>parentCommentId</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;child&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>}<span style=color:#f92672>&gt;</span> 
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>div</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>div</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>span</span><span style=color:#f92672>&gt;</span>{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>date</span>}<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/span&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>span</span><span style=color:#f92672>&gt;</span>{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>username</span>}<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/span&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/div&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/div&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>p</span><span style=color:#f92672>&gt;</span>{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>content</span>}<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/p&gt;{&#34; &#34;}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>button</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;button&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>onClick</span><span style=color:#f92672>=</span>{() =&gt; <span style=color:#a6e22e>setReply</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>reply</span>)}
</span></span><span style=display:flex><span>      <span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Reply</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/button&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// If the reply button is clicked, render the &lt;AddComment /&gt; form (that we&#39;ll build next)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      {<span style=color:#a6e22e>reply</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>AddComment</span> <span style=color:#a6e22e>slug</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>slug</span>} <span style=color:#a6e22e>parentCommentId</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>id</span>} <span style=color:#f92672>/&gt;</span>}
</span></span><span style=display:flex><span>      <span style=color:#75715e>// If there is any child comment, render those too
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>children</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>children</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>child</span>, <span style=color:#a6e22e>index</span>) =&gt; (
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Comment</span> <span style=color:#a6e22e>comment</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>child</span>} <span style=color:#a6e22e>slug</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>slug</span>} <span style=color:#a6e22e>key</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>index</span>} <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        ))}
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/div&gt;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=add-comment-form>Add Comment Form</h3><p>Then, we need to create the AddComment component that will render a form to create new comments or replies.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>useEffect</span>, <span style=color:#a6e22e>useState</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DeepMap</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FieldError</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SubmitHandler</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>useForm</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>UseFormHandleSubmit</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>UseFormRegister</span>,
</span></span><span style=display:flex><span>} <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react-hook-form&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>getKey</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@lib/utils&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>IComment</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@interfaces/Comment&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>AddComment</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>slug</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>parentCommentId</span>,
</span></span><span style=display:flex><span>}<span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>slug</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>parentCommentId</span><span style=color:#f92672>?:</span> <span style=color:#a6e22e>string</span>;
</span></span><span style=display:flex><span>})<span style=color:#f92672>:</span> <span style=color:#a6e22e>JSX</span>.<span style=color:#a6e22e>Element</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>commentSent</span>, <span style=color:#a6e22e>setCommentSent</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>isLoading</span>, <span style=color:#a6e22e>setIsLoading</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>register</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>handleSubmit</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reset</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>formState</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>errors</span> },
</span></span><span style=display:flex><span>  } <span style=color:#f92672>=</span> <span style=color:#a6e22e>useForm</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>FormData</span><span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>sendData</span>(<span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>FormData</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setIsLoading</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Prepare the new comment data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newComment</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>IComment</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>date</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toLocaleDateString</span>(<span style=color:#e6db74>&#34;en-US&#34;</span>), <span style=color:#75715e>// p
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>parentCommentId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>parentCommentId</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>undefined</span>, <span style=color:#75715e>// If this new comment has a parent, put the id here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>generateUUID</span>(), <span style=color:#75715e>// generate the unique id here however you want
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;Anonymous&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>email</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>content</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>children</span><span style=color:#f92672>:</span> [],
</span></span><span style=display:flex><span>		};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Send the new comment to an API endpoint we&#39;ll build later. It&#39;s important to pass the slug parameter and I&#39;m doing that with a path parameter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>`/api/comments/save/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>slug</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;POST&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;content-type&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;application/json&#34;</span>,
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>newComment</span>),
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>			.<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>					<span style=color:#75715e>// Comment was sent
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					<span style=color:#a6e22e>setCommentSent</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>setIsLoading</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>reset</span>({ <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span> });
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>			.<span style=color:#66d9ef>catch</span>(() =&gt; {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>setCommentSent</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>setIsLoading</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>				<span style=color:#75715e>// handle the error
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			});
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>onSubmit</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>SubmitHandler</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>FormData</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>data</span>) =&gt; <span style=color:#a6e22e>sendData</span>(<span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;&gt;</span>
</span></span><span style=display:flex><span>      {<span style=color:#f92672>!</span><span style=color:#a6e22e>isLoading</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>commentSent</span> <span style=color:#f92672>&amp;&amp;</span> (
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>CommentForm</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>onSubmit</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>onSubmit</span>}
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>register</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>register</span>}
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>handleSubmit</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>handleSubmit</span>}
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>errors</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>errors</span>}
</span></span><span style=display:flex><span>        <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      )}
</span></span><span style=display:flex><span>      {<span style=color:#a6e22e>isLoading</span> <span style=color:#f92672>&amp;&amp;</span> (
</span></span><span style=display:flex><span>       	<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>p</span><span style=color:#f92672>&gt;</span><span style=color:#a6e22e>Loading</span>...<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/p&gt;</span>
</span></span><span style=display:flex><span>      )}
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/p&gt;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>CommentForm</code> component is a basic <code>react-hook-form</code> form and it can be done however you want depending on your specific needs.</p><h3 id=full-comment-block>Full Comment Block</h3><p>This component is the one that will be imported in every post.
<code>CommentBlock</code> will require two props: <code>slug</code> and <code>comments</code>.
<code>slug</code> is the slug of the post we&rsquo;re in and will be used to create new comments, while <code>comments</code> is an array of comments retrieved in the page using <code>GetStaticProps</code> or <code>GetServerSideProps</code>, depending on our preference.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>dynamic</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;next/dynamic&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>useState</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>IComment</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@interfaces/Comment&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>CommentBlock</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>slug</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comments</span>,
</span></span><span style=display:flex><span>}<span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>slug</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>comments</span><span style=color:#f92672>:</span> Array<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>IComment</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>})<span style=color:#f92672>:</span> <span style=color:#a6e22e>JSX</span>.<span style=color:#a6e22e>Element</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Dynamically import everything to reduce the first load of a page. Also, there might be no comments at all.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Comment</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dynamic</span>(() =&gt; <span style=color:#66d9ef>import</span>(<span style=color:#e6db74>&#34;./Comment&#34;</span>));
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>AddComment</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dynamic</span>(() =&gt; <span style=color:#66d9ef>import</span>(<span style=color:#e6db74>&#34;./AddComment&#34;</span>));
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>showAddComment</span>, <span style=color:#a6e22e>setShowAddComment</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>div</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>p</span><span style=color:#f92672>&gt;</span><span style=color:#a6e22e>Comments</span><span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/p&gt;</span>
</span></span><span style=display:flex><span>			{<span style=color:#a6e22e>comments</span> <span style=color:#f92672>?</span> (
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>comments</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; (
</span></span><span style=display:flex><span>					<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Comment</span> <span style=color:#a6e22e>comment</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>c</span>} <span style=color:#a6e22e>key</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>getKey</span>()} <span style=color:#a6e22e>slug</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>slug</span>} <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>				))
</span></span><span style=display:flex><span>			) <span style=color:#f92672>:</span> (
</span></span><span style=display:flex><span>				<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>p</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>There</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>no</span> <span style=color:#a6e22e>comments</span>.
</span></span><span style=display:flex><span>				<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/p&gt;</span>
</span></span><span style=display:flex><span>			)}
</span></span><span style=display:flex><span>			{<span style=color:#a6e22e>showAddComment</span> <span style=color:#f92672>?</span> (
</span></span><span style=display:flex><span>				<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>AddComment</span> <span style=color:#a6e22e>slug</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>slug</span>} <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>			) <span style=color:#f92672>:</span> (
</span></span><span style=display:flex><span>				<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>div</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>					<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>button</span>
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;submit&#34;</span>
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>onClick</span><span style=color:#f92672>=</span>{() =&gt; <span style=color:#a6e22e>setShowAddComment</span>(<span style=color:#66d9ef>true</span>)}
</span></span><span style=display:flex><span>					<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>Comment</span>
</span></span><span style=display:flex><span>					<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/button&gt;</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/div&gt;</span>
</span></span><span style=display:flex><span>			)}
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/div&gt;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusions>Conclusions</h2><p>We just finished preparing the basic React structure of the commenting systems. Right now we just need to import the CommentBlock component where we want to display comments.
In the next article we&rsquo;ll build the APIs that will interface with Github in order to store and retrieve the comments.</p><p>Full Series:</p><ul><li>1/2 <a href=https://alessiofranceschi.dev/blog/nextjs-free-commenting-system-part-1/ title="NextJS Free Commenting System using Github Part 1">NextJS Free Commenting System using Github Part 1</a></li><li>2/2 <a href=https://alessiofranceschi.dev/blog/nextjs-free-commenting-system-part-2/ title="NextJS Free Commenting System using Github Part 2">NextJS Free Commenting System using Github Part 2</a></li></ul></article></section></div><footer class=footer><section class=container>Â©
2022
Alessio Franceschi
Â·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/PandaSekh/hugo-coder-lt>Coder-Lt</a>.</section></footer></main></body></html>