<!doctype html><html lang=en><head><title>Making Nested Comments - Building a Real-Time Commenting System in React [Part 2/3] Â· Alessio Franceschi</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light"><meta name=author content="Alessio Franceschi"><meta name=description content="A series on how to build a fully features Commenting System in Next.js (React)"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Making Nested Comments - Building a Real-Time Commenting System in React [Part 2/3]"><meta name=twitter:description content="A series on how to build a fully features Commenting System in Next.js (React)"><meta property="og:title" content="Making Nested Comments - Building a Real-Time Commenting System in React [Part 2/3]"><meta property="og:description" content="A series on how to build a fully features Commenting System in Next.js (React)"><meta property="og:type" content="article"><meta property="og:url" content="https://alessiofranceschi.dev/blog/react-commenting-system-part-2/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-01-13T00:00:00+00:00"><meta property="article:modified_time" content="2021-01-13T00:00:00+00:00"><meta property="og:see_also" content="https://alessiofranceschi.dev/blog/react-commenting-system-part-3/"><meta property="og:see_also" content="https://alessiofranceschi.dev/blog/react-commenting-system/"><link rel=canonical href=https://alessiofranceschi.dev/blog/react-commenting-system-part-2/><link rel=stylesheet href=/css/coder.min.c4d7e93a158eda5a65b3df343745d2092a0a1e2170feeec909b8a89443903c6a.css integrity="sha256-xNfpOhWO2lpls980N0XSCSoKHiFw/u7JCbiolEOQPGo=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/image/favicon.png sizes=32x32><link rel=icon type=image/png href=/image/favicon.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.102.3"></head><body class="preload-transitions colorscheme-light"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Alessio Franceschi</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/blog/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container page"><article><header><h1 class=title><a class=title-link href=https://alessiofranceschi.dev/blog/react-commenting-system-part-2/>Making Nested Comments - Building a Real-Time Commenting System in React [Part 2/3]</a></h1></header><p>In the <a href=https://alessiofranceschi.dev/blog/react-commenting-system/ title="previous part of this series">previous part of this series</a> we created the foundations of this project and now we have a basic commenting system where we can create and display comments in real time. This time we&rsquo;re going to add some extra functionalities, like nested comments and markdown support.</p><div><h2>Table Of Contents</h2><nav id=TableOfContents><ul><li><a href=#nested-comments>Nested Comments</a><ul><li><a href=#how-to-do-nested-comments>How to do Nested Comments</a></li><li><a href=#create-a-child-comment>Create a Child Comment</a></li></ul></li><li><a href=#markdown-support>Markdown Support</a></li><li><a href=#recaptcha>reCAPTCHA</a></li></ul></nav></div><h2 id=nested-comments>Nested Comments</h2><p>There are a lot of ways to do nested comments and some of them may work better than my method, but for what we need and use (real time updates and Sanity.io as dataset), I found this to be the best approach.</p><h3 id=how-to-do-nested-comments>How to do Nested Comments</h3><p>In the previous post we created a <code>Comment</code> schema which included an array of comments that we called <code>childComments</code>. To add a child comment, we&rsquo;re going to update the parent by appending the child to the array. If we want a nephew comment (never heard of this, but I&rsquo;m going to use these words together anyway), we will update his parent comment same as before, and then we&rsquo;re going to update the parent comment (the granddad comment) with the updated child. I am confused too just by writing this, but I promise it&rsquo;s going to be easier when we actually start programming this. Long story short, when we add a child comment, we need to update its parent, then its grandparent and so on. This may seem inefficient, and it probably is for huge amounts of comments, but my objective wasn&rsquo;t building the new Facebook commenting system. My approach has some advantages:</p><ul><li>We greatly reduce calls to the backend, because with a single query we get all the comments;</li><li>The comments are already nested in the backend, we only need to iterate them, not sort them;</li><li>Cleaner data in the backend, no need to have references everywhere.</li></ul><p>Again, this might seem confusing but it&rsquo;s going to be clearer soon.</p><h3 id=create-a-child-comment>Create a Child Comment</h3><h4 id=front-end---singlecomment-component>Front-End - SingleComment Component</h4><p>Finally we can code something. First of all, we need to add a <em>Reply</em> button to every comment, so open the <code>SingleComment</code> component. We can simply add the <code>AddComment</code> component, but it&rsquo;s going to be pretty ugly, so we&rsquo;ll add a basic toggle.
Let&rsquo;s add a state for the reply box and a toggle function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>showReplyBox</span>, <span style=color:#a6e22e>setShowReplyBox</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>toggleReplyBox</span> <span style=color:#f92672>=</span> () =&gt; <span style=color:#a6e22e>setShowReplyBox</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>showReplyBox</span>);
</span></span></code></pre></div><p>Then a button to activate the toggle</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span>&lt;<span style=color:#f92672>button</span> <span style=color:#a6e22e>onClick</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>toggleReplyBox</span>}&gt;<span style=color:#a6e22e>Reply</span>&lt;/<span style=color:#f92672>button</span>&gt;
</span></span></code></pre></div><p>And now just add the <code>AddComment</code> component, but with some extra props. As said in the previous section, whenever we add a new child we need to update its parent and its &ldquo;first parent&rdquo;, basically the first comment in the hierarchy that isn&rsquo;t a child comment. This is needed because of how Sanity.io works. I explain this better and the end of the chapter, just know that if you are using a different dataset you might not need this prop.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span>{<span style=color:#a6e22e>showReplyBox</span> <span style=color:#f92672>&amp;&amp;</span> (
</span></span><span style=display:flex><span>	&lt;<span style=color:#f92672>AddComment</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>parentCommentId</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>_id</span>}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>firstParentId</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>firstParentId</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>_id</span>}
</span></span><span style=display:flex><span>	/&gt;
</span></span><span style=display:flex><span>)}
</span></span></code></pre></div><p><code>parentCommentId</code> is the id of the current comment from where we&rsquo;re generating the child, while we&rsquo;ve never seen <code>firstParentId</code>. Basically, this is going to be the id of the &ldquo;first parent&rdquo; we mentioned before. We&rsquo;re going to get it from the <code>SingleComment</code> component props, like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>export</span>  <span style=color:#66d9ef>default</span>  <span style=color:#66d9ef>function</span>  <span style=color:#a6e22e>Comment</span>({  <span style=color:#a6e22e>comment</span>,  <span style=color:#a6e22e>firstParentId</span>  })  { ... }
</span></span></code></pre></div><p>We pass this &ldquo;first parent&rdquo; id as prop when rendering the children, like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span>{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>childComments</span> <span style=color:#f92672>&amp;&amp;</span> (
</span></span><span style=display:flex><span>	&lt;<span style=color:#f92672>ul</span>&gt;
</span></span><span style=display:flex><span>		{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>childComments</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>childComment</span> =&gt; (
</span></span><span style=display:flex><span>			&lt;<span style=color:#f92672>Comment</span>
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>comment</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>childComment</span>}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>key</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>childComment</span>.<span style=color:#a6e22e>_id</span>}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>firstParentId</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>firstParentId</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>_id</span>}
</span></span><span style=display:flex><span>			/&gt;
</span></span><span style=display:flex><span>		))}
</span></span><span style=display:flex><span>	&lt;/<span style=color:#f92672>ul</span>&gt;
</span></span><span style=display:flex><span>)}
</span></span></code></pre></div><p>How does this work? Basically, when we have to render the first layer of comments (those that are not children comments), we do it in the <code>AllComments</code> component we created in the previous post:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>commentList</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>comments</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>comment</span> =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>Comment</span> <span style=color:#a6e22e>key</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>_id</span>} <span style=color:#a6e22e>comment</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>comment</span>} /&gt;;
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Here we pass no <code>firstParentId</code>, meaning that those components have the variable undefined. Because of that, when we render the <code>AddComment</code> or all the child comments, we pass the comment id: <code>firstParentId={firstParentId || comment._id}</code>. Those child comments will have the <code>firstParentId</code> defined and will use that when creating new comments or showing children. This means that no matter how many children there are, they all have the <code>firstCommentId</code> props setted to the id of the first comment in the hierarchy. This sounds complicated, but it&rsquo;s just needed to perform an update in the database when we create new comments, because Sanity.io can perform queries only on first level documents. If we have nested documents, like we do, even if those documents have an <code>_id</code>, a <code>_key</code> and a <code>_type</code>, they still can&rsquo;t be &ldquo;searchable&rdquo;. That&rsquo;s why we have to do all of this &ldquo;first parent&rdquo; thing.</p><p>One last thing, let&rsquo;s add a custom class in case the comment is a child, so that later we can style it accordingly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span>&lt;<span style=color:#f92672>li</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>key</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>_id</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>id</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>_id</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>className</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>firstParentId</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;child&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>}
</span></span><span style=display:flex><span>&gt;
</span></span></code></pre></div><h4 id=front-end---addcommentform-component>Front-End - AddCommentForm Component</h4><p>We now need to modify the form to create comments by adding the parent comment id and the first parent id. We can get them from the props and then add them to the data we send to the API endpoint.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>AddCommentForm</span>({<span style=color:#a6e22e>parentCommentId</span>, <span style=color:#a6e22e>firstParentId</span>}){
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>onSubmit</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>data</span> =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>setIsSending</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>parentCommentId</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>parentCommentId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parentCommentId</span>;
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>firstParentId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>firstParentId</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#34;/api/addComment&#34;</span>, {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;POST&#34;</span>, 
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>r</span> =&gt; {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>200</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>setIsSending</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> <span style=color:#75715e>// handle errors;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That&rsquo;s all for this component.</p><h4 id=backend---addcomment-api>Backend - addComment API</h4><p>In this serverless function we&rsquo;ll handle the creation of child comments.
As child comments are created differently from parent ones, let&rsquo;s add an if-else statement inside the try block.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>parentCommentId</span>) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Remove these values from the document, as they&#39;re not expected in the database
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>firstParentId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>firstParentId</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parentCommentId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>parentCommentId</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>delete</span> <span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>parentCommentId</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>delete</span> <span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>firstParentId</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>appendChildComment</span>(<span style=color:#a6e22e>firstParentId</span>, <span style=color:#a6e22e>parentCommentId</span>, <span style=color:#a6e22e>doc</span>).<span style=color:#a6e22e>then</span>(
</span></span><span style=display:flex><span>			() =&gt; {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>resolve</span>(
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Comment Created&#34;</span> })
</span></span><span style=display:flex><span>				);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		);
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// If there&#39;s no parentCommentId, just create a new comment like before
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>writeClient</span>.<span style=color:#a6e22e>create</span>(<span style=color:#a6e22e>doc</span>).<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>resolve</span>(
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Comment Created&#34;</span> })
</span></span><span style=display:flex><span>			);
</span></span><span style=display:flex><span>		});
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> String(<span style=color:#a6e22e>err</span>) }));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If there&rsquo;s a parent comment id, then it is a child comment. We remove those two variables from the document, otherwise Sanity.io will have problems, and then call a function to append the child comment to the parent comment. The remaining code is the same as before.</p><p>Now we need to create the function to actually append the child comment. This function will require 3 parameters: the id of the first parent, the id of the parent comment and the child comment itself.
Inside we get the first parent comment and append the child accordingly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>appendChildComment</span>(<span style=color:#a6e22e>firstParentId</span>, <span style=color:#a6e22e>parentCommentId</span>, <span style=color:#a6e22e>childComment</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#66d9ef>async</span> <span style=color:#a6e22e>resolve</span> =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Get the first level parent comment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>query</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`*[_type == &#34;comment&#34; &amp;&amp; _id == &#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>firstParentId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;][0]`</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parentComment</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>writeClient</span>.<span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>query</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>parentComment</span>.<span style=color:#a6e22e>childComments</span>) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Parent Comment has no children, just create a new Array with the child comment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>parentComment</span>.<span style=color:#a6e22e>childComments</span> <span style=color:#f92672>=</span> [<span style=color:#a6e22e>childComment</span>];
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>parentComment</span>.<span style=color:#a6e22e>_id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>parentCommentId</span>) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Parent Comment is a first level comment, so just append the comment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>parentComment</span>.<span style=color:#a6e22e>childComments</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>				...<span style=color:#a6e22e>parentComment</span>.<span style=color:#a6e22e>childComments</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>c</span> =&gt; <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>_id</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>childComment</span>.<span style=color:#a6e22e>_id</span>),
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>childComment</span>,
</span></span><span style=display:flex><span>			];
</span></span><span style=display:flex><span>			<span style=color:#75715e>// The filter is not necessary right now, but in case you want to add an Edit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// functionality, you&#39;ll need this.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Parent comment is a level two or more nested comment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// We need to find the actual parent comment in all nested comments
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>childToUpdate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getChildComment</span>(<span style=color:#a6e22e>parentComment</span>, <span style=color:#a6e22e>parentCommentId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>childToUpdate</span>.<span style=color:#a6e22e>childComments</span>) {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Parent comment has no children, create new Array with the new child
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>childToUpdate</span>.<span style=color:#a6e22e>childComments</span> <span style=color:#f92672>=</span> [<span style=color:#a6e22e>childComment</span>];
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Parent comment already has some children
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// Append the new childComment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>childToUpdate</span>.<span style=color:#a6e22e>childComments</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>					...<span style=color:#a6e22e>childToUpdate</span>.<span style=color:#a6e22e>childComments</span>.<span style=color:#a6e22e>filter</span>(
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>c</span> =&gt; <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>_id</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>childComment</span>.<span style=color:#a6e22e>_id</span>
</span></span><span style=display:flex><span>					),
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>childComment</span>
</span></span><span style=display:flex><span>				];
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Patch the document
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>writeClient</span>
</span></span><span style=display:flex><span>			.<span style=color:#a6e22e>patch</span>(<span style=color:#a6e22e>parentComment</span>.<span style=color:#a6e22e>_id</span>)
</span></span><span style=display:flex><span>			.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>parentComment</span>)
</span></span><span style=display:flex><span>			.<span style=color:#a6e22e>commit</span>()
</span></span><span style=display:flex><span>			.<span style=color:#a6e22e>then</span>(() =&gt; <span style=color:#a6e22e>resolve</span>());
</span></span><span style=display:flex><span>	});
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Let&rsquo;s analyze the code block by block.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>parentComment</span>.<span style=color:#a6e22e>childComments</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>parentComment</span>.<span style=color:#a6e22e>childComments</span> <span style=color:#f92672>=</span> [<span style=color:#a6e22e>childComment</span>];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If the first parent comment has no children, just append the new children in a new array.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>parentComment</span>.<span style=color:#a6e22e>_id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>parentCommentId</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>parentComment</span>.<span style=color:#a6e22e>childComments</span> <span style=color:#f92672>=</span> [...<span style=color:#a6e22e>parentComment</span>.<span style=color:#a6e22e>childComments</span>, <span style=color:#a6e22e>childComment</span>];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If the parent is a first parent, meaning that it is not a child itself, append the comment to the other children.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>childToUpdate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getChildComment</span>(<span style=color:#a6e22e>parentComment</span>, <span style=color:#a6e22e>parentCommentId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>childToUpdate</span>.<span style=color:#a6e22e>childComments</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>childToUpdate</span>.<span style=color:#a6e22e>childComments</span> <span style=color:#f92672>=</span> [<span style=color:#a6e22e>childComment</span>];
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>childToUpdate</span>.<span style=color:#a6e22e>childComments</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>			...<span style=color:#a6e22e>childToUpdate</span>.<span style=color:#a6e22e>childComments</span>.<span style=color:#a6e22e>filter</span>(
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>c</span> =&gt; <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>_id</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>childComment</span>.<span style=color:#a6e22e>_id</span>
</span></span><span style=display:flex><span>			),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>childComment</span>
</span></span><span style=display:flex><span>		];
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If we arrive here, the parent is a child itself and so we need to get this parent comment, update it and then patch the first parent comment in the database.
The function <code>getChildComment</code> iterates all children to find the comment we need to update, then the remainder of the code is basically the same as the previous part.</p><p>To patch the document we just follow Sanity.io <a href=https://www.sanity.io/docs/js-client>documentation</a>.</p><p>The <code>getChildComment</code> function is recursive and will return the comment that needs to be updated.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getChildComment</span>(<span style=color:#a6e22e>firstParentComment</span>, <span style=color:#a6e22e>childCommentId</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>returnComment</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>firstParentComment</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>childComments</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>c</span> =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>_id</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>childCommentId</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>returnComment</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>childComments</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>returnComment</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getChildComment</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>childCommentId</span>);
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>returnComment</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	});
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>returnComment</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And with that done, we finally have nested comments. Styling is out of scope for this articles, but a quick tip is that you can add a <code>margin-left</code> property to the <code>child</code> class to have the child comment slighty moved to the right. As this property is relative to the parent DOM element, we can get a &ldquo;nested comments&rdquo; style pretty easily.</p><h2 id=markdown-support>Markdown Support</h2><p>I wanted to add markdown support because I like to make comments readable and walls of text are not great for that, but I didn&rsquo;t want anything too heavy or complicated for the end user.
I ended up using a library called <a href=https://github.com/developit/snarkdown>snarkdown</a>. I simply copy-pasted the source code in my project under <code>lib/snarkdown.js</code> to remove support for images and headings because we don&rsquo;t need that.</p><p>The final code is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TAGS</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;&lt;em&gt;&#34;</span>, <span style=color:#e6db74>&#34;&lt;/em&gt;&#34;</span>],
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;&lt;strong&gt;&#34;</span>, <span style=color:#e6db74>&#34;&lt;/strong&gt;&#34;</span>],
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;*&#34;</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;&lt;strong&gt;&#34;</span>, <span style=color:#e6db74>&#34;&lt;/strong&gt;&#34;</span>],
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;~&#34;</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;&lt;s&gt;&#34;</span>, <span style=color:#e6db74>&#34;&lt;/s&gt;&#34;</span>],
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;\n&#34;</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;&lt;br /&gt;&#34;</span>],
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34; &#34;</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;&lt;br /&gt;&#34;</span>],
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;-&#34;</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;&lt;hr /&gt;&#34;</span>],
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** Outdent a string based on the first indented line&#39;s leading whitespace
</span></span></span><span style=display:flex><span><span style=color:#75715e> *	@private
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>outdent</span>(<span style=color:#a6e22e>str</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>str</span>.<span style=color:#a6e22e>replace</span>(
</span></span><span style=display:flex><span>		RegExp(<span style=color:#e6db74>&#34;^&#34;</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>str</span>.<span style=color:#a6e22e>match</span>(<span style=color:#e6db74>/^(\t| )+/</span>) <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;&#34;</span>)[<span style=color:#ae81ff>0</span>], <span style=color:#e6db74>&#34;gm&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** Encode special attribute characters to HTML entities in a String.
</span></span></span><span style=display:flex><span><span style=color:#75715e> *	@private
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>encodeAttr</span>(<span style=color:#a6e22e>str</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>str</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>		.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/&#34;/g</span>, <span style=color:#e6db74>&#34;&amp;quot;&#34;</span>)
</span></span><span style=display:flex><span>		.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/&lt;/g</span>, <span style=color:#e6db74>&#34;&amp;lt;&#34;</span>)
</span></span><span style=display:flex><span>		.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/&gt;/g</span>, <span style=color:#e6db74>&#34;&amp;gt;&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** Parse Markdown into an HTML String. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>md</span>, <span style=color:#a6e22e>prevLinks</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>tokenizer</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/((?:^|\n+)(?:\n---+|\* \*(?: \*)+)\n)|(?:^``` *(\w*)\n([\s\S]*?)\n```$)|((?:(?:^|\n+)(?:\t|  {2,}).+)+\n*)|((?:(?:^|\n)([&gt;*+-]|\d+\.)\s+.*)+)|(?:!\[([^\]]*?)\]\(([^)]+?)\))|(\[)|(\](?:\(([^)]+?)\))?)|(?:(?:^|\n+)([^\s].*)\n(-{3,}|={3,})(?:\n+|$))|(?:(?:^|\n+)(#{1,6})\s*(.+)(?:\n+|$))|(?:`([^`].*?)`)|(  \n\n*|\n{2,}|__|\*\*|[_*]|~~)/gm</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>context</span> <span style=color:#f92672>=</span> [],
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>links</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>prevLinks</span> <span style=color:#f92672>||</span> {},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>last</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>chunk</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>prev</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>token</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>inner</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>tag</span>(<span style=color:#a6e22e>token</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>desc</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>TAGS</span>[<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;&#34;</span>];
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>end</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>context</span>[<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>desc</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>desc</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desc</span>[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>end</span>) <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>pop</span>();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>desc</span>[<span style=color:#a6e22e>end</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>flush</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>str</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>length</span>) <span style=color:#a6e22e>str</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>tag</span>(<span style=color:#a6e22e>context</span>[<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>str</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>md</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>md</span>
</span></span><span style=display:flex><span>		.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/^\[(.+?)\]:\s*(.+)$/gm</span>, (<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>url</span>) =&gt; {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>links</span>[<span style=color:#a6e22e>name</span>.<span style=color:#a6e22e>toLowerCase</span>()] <span style=color:#f92672>=</span> <span style=color:#a6e22e>url</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>		.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/^\n+|\n+$/g</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> ((<span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tokenizer</span>.<span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>md</span>))) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>prev</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>md</span>.<span style=color:#a6e22e>substring</span>(<span style=color:#a6e22e>last</span>, <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>index</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>last</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tokenizer</span>.<span style=color:#a6e22e>lastIndex</span>;
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>chunk</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>prev</span>.<span style=color:#a6e22e>match</span>(<span style=color:#e6db74>/[^\\](\\\\)*\\$/</span>)) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// escaped
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Code/Indent blocks:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> ((<span style=color:#a6e22e>t</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>3</span>] <span style=color:#f92672>||</span> <span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>4</span>])) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>chunk</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#39;&lt;pre class=&#34;code &#39;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>				(<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;poetry&#34;</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>2</span>].<span style=color:#a6e22e>toLowerCase</span>()) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#39;&#34;&gt;&lt;code&#39;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>				(<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>					<span style=color:#f92672>?</span> <span style=color:#e6db74>` class=&#34;language-</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>2</span>].<span style=color:#a6e22e>toLowerCase</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;`</span>
</span></span><span style=display:flex><span>					<span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;&gt;&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>outdent</span>(<span style=color:#a6e22e>encodeAttr</span>(<span style=color:#a6e22e>t</span>).<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/^\n+|\n+$/g</span>, <span style=color:#e6db74>&#34;&#34;</span>)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;&lt;/code&gt;&lt;/pre&gt;&#34;</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// &gt; Quotes, -* lists:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> ((<span style=color:#a6e22e>t</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>6</span>])) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>match</span>(<span style=color:#e6db74>/\./</span>)) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>5</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>5</span>].<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/^\d+/gm</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>inner</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>outdent</span>(<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>5</span>].<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/^\s*[&gt;*+.-]/gm</span>, <span style=color:#e6db74>&#34;&#34;</span>)));
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&gt;&#34;</span>) <span style=color:#a6e22e>t</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;blockquote&#34;</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>t</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>match</span>(<span style=color:#e6db74>/\./</span>) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;ol&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ul&#34;</span>;
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>inner</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>inner</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/^(.*)(\n|$)/gm</span>, <span style=color:#e6db74>&#34;&lt;li&gt;$1&lt;/li&gt;&#34;</span>);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>chunk</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>t</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&gt;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>inner</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>t</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&gt;&#34;</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Links:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>10</span>]) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>out</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>replace</span>(
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;&lt;a&gt;&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>`&lt;a href=&#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>encodeAttr</span>(
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>11</span>] <span style=color:#f92672>||</span> <span style=color:#a6e22e>links</span>[<span style=color:#a6e22e>prev</span>.<span style=color:#a6e22e>toLowerCase</span>()]
</span></span><span style=display:flex><span>				)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;&gt;`</span>
</span></span><span style=display:flex><span>			);
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>chunk</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>flush</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;/a&gt;&#34;</span>;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>9</span>]) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>chunk</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;a&gt;&#34;</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// `code`:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>16</span>]) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>chunk</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;code&gt;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>encodeAttr</span>(<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>16</span>]) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;/code&gt;&#34;</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Inline formatting: *em*, **strong** &amp; friends
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>17</span>] <span style=color:#f92672>||</span> <span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>1</span>]) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>chunk</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tag</span>(<span style=color:#a6e22e>token</span>[<span style=color:#ae81ff>17</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;--&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>prev</span>;
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>chunk</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>out</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>md</span>.<span style=color:#a6e22e>substring</span>(<span style=color:#a6e22e>last</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>flush</span>()).<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/^\n+|\n+$/g</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now, in <code>components/Comments/SingleComment.js</code> we can parse the comment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>parser</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../lib/snarkdown&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>p</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;comment-content&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dangerouslySetInnerHTML</span><span style=color:#f92672>=</span>{<span style=color:#f92672>/</span>{ <span style=color:#75715e>//remove the slash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>__html</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>parser</span>(<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>trim</span>()),
</span></span><span style=display:flex><span>	}}
</span></span><span style=display:flex><span>/&gt;
</span></span></code></pre></div><h2 id=recaptcha>reCAPTCHA</h2><p>We&rsquo;re going to interate Google reCAPTCHA to avoid any spammy comments.
First, get an API key from <a href=https://www.google.com/recaptcha/admin>here</a> and add it to your env (this is my suggested method and the most secure one, you can use what you prefer).
Usually we should load the reCAPTCHA javascript in the head of our document, but I prefer to lazy-load things when possible. To do so, install a library I wrote to load the JS file only when e&rsquo;re loading the comments.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>npm i @pandasekh/dynamic-script-loader
</span></span></code></pre></div><p>Now open the <code>/components/Comments/AllComments.js</code> file. We need to import the library and load reCAPTCHA&rsquo;s javascript in the <code>useEffect</code> hook.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>load</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@pandasekh/dynamic-script-loader&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>useEffect</span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		[...]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Dynamically import Google reCAPTCHA
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>load</span>(<span style=color:#e6db74>`https://www.google.com/recaptcha/api.js?render=YOUR_API_KEY`</span>);
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		[...]
</span></span><span style=display:flex><span>	}, []);
</span></span></code></pre></div><p>Now we have reCAPTCHA ready. Let&rsquo;s modify our <code>AddCommentForm.js</code> so that it generates a token for reCAPTCHA to verify in the backend.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#75715e>// components/AddComment/AddCommentForm.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>onSubmit</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>data</span> =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>setIsSending</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>parentCommentId</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>parentCommentId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parentCommentId</span>;
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>firstParentId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>firstParentId</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>grecaptcha</span>.<span style=color:#a6e22e>ready</span>(() =&gt; {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>grecaptcha</span>
</span></span><span style=display:flex><span>				.<span style=color:#a6e22e>execute</span>(<span style=color:#a6e22e>YOUR_SITE_KEY</span>, {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;submit&#34;</span>,
</span></span><span style=display:flex><span>				})
</span></span><span style=display:flex><span>				.<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>token</span> =&gt; {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#34;/api/addComment&#34;</span>, {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;POST&#34;</span>, 
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>						}
</span></span><span style=display:flex><span>					).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>r</span> =&gt; {
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>200</span>) {
</span></span><span style=display:flex><span>							<span style=color:#a6e22e>setIsSending</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>						} <span style=color:#66d9ef>else</span> <span style=color:#75715e>// handle errors;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>					})
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[...]
</span></span></code></pre></div><p>And finally, we just have to verify this token in the backend.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// pages/api/sendComment.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>doc</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Check ReCaptcha Token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>verifyRecaptchaToken</span>(<span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>token</span>).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>isValidToken</span> =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>isValidToken</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>406</span>).<span style=color:#a6e22e>end</span>());
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>delete</span> <span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>verifyRecaptchaToken</span>(<span style=color:#a6e22e>token</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#34;https://www.google.com/recaptcha/api/siteverify&#34;</span>, {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;POST&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> { <span style=color:#e6db74>&#34;Content-Type&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;application/x-www-form-urlencoded&#34;</span> },
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`secret=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>YOUR_SECRET_KEY</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;response=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>		.<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>r</span> =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>json</span>())
</span></span><span style=display:flex><span>		.<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>j</span> =&gt; {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>j</span>.<span style=color:#a6e22e>success</span>;
</span></span><span style=display:flex><span>		});
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That&rsquo;s all for this post. In the next one we&rsquo;ll finally add some reactions to our comments!</p><p>Full Series:</p><ul><li>1/3 <a href=https://alessiofranceschi.dev/blog/react-commenting-system/ title="Building a Real-Time Commenting System in React">Building a Real-Time Commenting System in React</a></li><li>2/3 <a href=https://alessiofranceschi.dev/blog/react-commenting-system-part-2/ title="Making Nested Comments">Making Nested Comments</a></li><li>3/3 <a href=https://alessiofranceschi.dev/blog/react-commenting-system-part-3/ title="Emoji Reactions for Comments">Emoji Reactions for Comments</a></li></ul></article></section></div><footer class=footer><section class=container>Â©
2022
Alessio Franceschi
Â·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/PandaSekh/hugo-coder-lt>Coder-Lt</a>.</section></footer></main></body></html>